<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain-Op | Entrenamiento Estratégico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }

        .animate-pulse-slow { 
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; 
        }

        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: .7; } 
        }

        /* Estilo para que Lucide funcione bien con el wrapper de React */
        .lucide-icon-wrapper i { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }

        /* Suavizado de bordes y sombras */
        .custom-shadow {
            box-shadow: 0 10px 30px -5px rgba(79, 70, 229, 0.1), 0 4px 10px -5px rgba(79, 70, 229, 0.05);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;
        
        // --- ADAPTADOR DE ICONOS (Restaurado) ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    iconRef.current.innerHTML = `<i data-lucide="${kebabName}"></i>`;
                    
                    window.lucide.createIcons({
                        attrs: {
                            'stroke-width': 2.5,
                            width: size,
                            height: size,
                            class: className,
                            stroke: 'currentColor'
                        }
                    });
                }
            }, [name, size, className]);

            return <span ref={iconRef} className="lucide-icon-wrapper inline-flex items-center justify-center leading-none"></span>;
        };

        const GAMES = { LOGIN: 'login', MENU: 'menu', CALCULO: 'calculo', ATENCION: 'atencion', MEMORIA: 'memoria', RANKING: 'ranking' };

        const App = () => {
            const [user, setUser] = useState({ uid: 'demo-user' }); // Fallback para que no se bloquee
            const [profile, setProfile] = useState(null);
            const [view, setView] = useState('loading');
            const [score, setScore] = useState(0);
            const [gameState, setGameState] = useState('idle');
            const [timeLeft, setTimeLeft] = useState(30);
            const [ranking, setRanking] = useState([]);

            const [math, setMath] = useState({ q: '', isCorrect: true, displayA: 0 });
            const [attention, setAttention] = useState([]);
            const [sequence, setSequence] = useState([]);
            const [userSeq, setUserSeq] = useState([]);

            const memorySteps = [
                { id: 'MessageSquare', label: 'Saludo' },
                { id: 'Target', label: 'Indagación' },
                { id: 'Brain', label: 'Empatía' },
                { id: 'Award', label: 'Propuesta' },
                { id: 'Check', label: 'Cierre' }
            ];

            // --- Lógica de Inicio (Restaurada y Protegida) ---
            useEffect(() => {
                const initApp = () => {
                    const savedProfile = localStorage.getItem('brain_op_profile');
                    if (savedProfile) {
                        setProfile(JSON.parse(savedProfile));
                        setView(GAMES.MENU);
                    } else {
                        setView(GAMES.LOGIN);
                    }
                };
                setTimeout(initApp, 1000);
            }, []);

            const handleRegister = (e) => {
                e.preventDefault();
                const data = {
                    uid: 'user-' + Date.now(),
                    name: e.target.name.value,
                    university: e.target.uni.value,
                    totalPoints: 0,
                    highScore: 0,
                    lastActive: new Date().toISOString()
                };
                localStorage.setItem('brain_op_profile', JSON.stringify(data));
                setProfile(data);
                setView(GAMES.MENU);
            };

            const saveScore = (finalScore) => {
                if (!profile) return;
                const updated = {
                    ...profile,
                    totalPoints: (profile.totalPoints || 0) + finalScore,
                    highScore: Math.max(profile.highScore || 0, finalScore)
                };
